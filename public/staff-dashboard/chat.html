<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask Protractor - Sylvan Lake AutoPro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231e3a8a' width='100' height='100' rx='20'/><text y='.9em' x='50%' text-anchor='middle' font-size='60' fill='%23facc15'>AP</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>@keyframes spin { to { transform: rotate(360deg); } } .animate-spin { animation: spin 1s linear infinite; }
  .chat-response h1,.chat-response h2,.chat-response h3{font-weight:600;margin:1em 0 0.5em}.chat-response ul,.chat-response ol{margin:0.5em 0;padding-left:1.5em}.chat-response li{margin:0.25em 0}.chat-response p{margin:0.5em 0}.chat-response code{background:#f1f5f9;padding:0.2em 0.4em;border-radius:4px;font-size:0.9em}.chat-response pre{background:#1e293b;color:#e2e8f0;padding:1em;border-radius:8px;overflow-x:auto;margin:1em 0}.chat-response pre code{background:none;padding:0}</style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div id="app"></div>
  <script src="js/config.js"></script>
  <script>
    const ACTIVE_TAB = 'chat';
    let state = { messages: [], input: '', loading: false };

    async function sendMessage() {
      const msg = state.input.trim();
      if (!msg || state.loading) return;
      state.messages.push({ role: 'user', content: msg });
      state.input = '';
      state.loading = true;
      render();
      try {
        const r = await fetch(PROTRACTOR_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, context: 'dashboard' })
        });
        const data = await r.json();
        state.messages.push({ role: 'assistant', content: data.response || data.message || 'No response received.' });
      } catch (err) {
        state.messages.push({ role: 'assistant', content: `Error: ${err.message}` });
      }
      state.loading = false;
      render();
      setTimeout(() => document.getElementById('chat-container')?.scrollTo(0, 999999), 100);
    }

    function handleKeydown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
    function updateInput(val) { state.input = val; }
    function clearChat() { state.messages = []; render(); }

    function renderHeader() {
      const tabs = [
        { id: 'invoices', label: 'Invoices', href: 'invoices.html', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
        { id: 'cores_warranty', label: 'Core & Warranty', href: 'cores-warranty.html', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },
        { id: 'emails', label: 'Emails', href: 'emails.html', icon: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
        { id: 'statements', label: 'Statements', href: 'statements.html', icon: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
        { id: 'bookkeeper', label: 'Bookkeeper', href: 'bookkeeper.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z' },
        { id: 'chat', label: 'Ask Protractor', href: 'chat.html', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z' },
        { id: 'search', label: 'Search', href: 'search.html', icon: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' },
        { id: 'settings', label: '', href: 'settings.html', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z', isSettings: true }
      ];
      return `<header class="bg-blue-900 text-white shadow-lg"><div class="max-w-7xl mx-auto px-4 py-3"><div class="flex items-center gap-4"><div class="bg-yellow-400 text-blue-900 font-bold px-3 py-1 rounded text-lg">NAPA</div><div><h1 class="text-xl font-semibold">Sylvan Lake AutoPro</h1><p class="text-blue-200 text-sm">Business Dashboard</p></div><div class="ml-auto"><button onclick="clearChat()" class="px-3 py-1.5 bg-blue-800 hover:bg-blue-700 rounded-lg text-sm">üóëÔ∏è Clear</button></div></div></div><div class="bg-blue-800"><div class="max-w-7xl mx-auto px-4"><div class="flex items-end pt-2 overflow-x-auto">${tabs.map((t,i)=>{const a=t.id===ACTIVE_TAB,c=a?'bg-white text-slate-800 border-t border-l border-r border-slate-300':'bg-slate-100 text-slate-600 hover:bg-slate-50 border border-transparent';return t.isSettings?`<a href="${t.href}" class="flex items-center justify-center w-10 h-10 rounded-t-lg ml-1 ${c}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${t.icon}"></path></svg></a>`:`<a href="${t.href}" class="flex items-center gap-2 px-5 py-2.5 text-sm font-medium rounded-t-lg ${i>0?'ml-1':''} whitespace-nowrap ${c}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${t.icon}"></path></svg>${t.label}</a>`;}).join('')}</div></div></div></header>`;
    }

    function render() {
      document.getElementById('app').innerHTML = `
        ${renderHeader()}
        <main class="max-w-4xl mx-auto px-4 py-6 flex flex-col" style="height: calc(100vh - 140px)">
          <div id="chat-container" class="flex-1 overflow-y-auto bg-white rounded-t-xl shadow-lg p-4 space-y-4">
            ${state.messages.length === 0 ? `
              <div class="text-center py-12 text-slate-500">
                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                <p class="text-lg font-medium">Ask Protractor anything</p>
                <p class="text-sm mt-2">Questions about invoices, parts, suppliers, or shop operations</p>
              </div>
            ` : state.messages.map(m => `
              <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="${m.role === 'user' ? 'bg-blue-900 text-white' : 'bg-slate-100 text-slate-800'} rounded-2xl px-4 py-3 max-w-[80%] ${m.role === 'assistant' ? 'chat-response' : ''}">
                  ${m.role === 'assistant' ? marked.parse(m.content) : m.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                </div>
              </div>
            `).join('')}
            ${state.loading ? `<div class="flex justify-start"><div class="bg-slate-100 rounded-2xl px-4 py-3"><div class="flex gap-1"><span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0.1s"></span><span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0.2s"></span></div></div></div>` : ''}
          </div>
          <div class="bg-white rounded-b-xl shadow-lg border-t p-4">
            <div class="flex gap-3">
              <textarea id="chat-input" rows="2" placeholder="Ask a question..." class="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" onkeydown="handleKeydown(event)" oninput="updateInput(this.value)">${state.input}</textarea>
              <button onclick="sendMessage()" ${state.loading?'disabled':''} class="px-6 py-3 bg-blue-900 hover:bg-blue-800 disabled:bg-slate-400 text-white font-medium rounded-xl transition-colors">${state.loading?'...':'Send'}</button>
            </div>
          </div>
        </main>`;
      const input = document.getElementById('chat-input');
      if (input) input.value = state.input;
    }

    render();
  </script>
</body>
</html>
